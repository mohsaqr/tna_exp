---
title: "Clustering example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Clustering example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 10,
  fig.height = 6,
  out.width = "100%",
  dpi = 300,
  comment = "#>"
)
```

Importing libraries
```{r, warning = F,  message = FALSE, results = FALSE }
library("tna")
library("tibble")
library("dplyr")
library("gt")
library("seqHMM")
```

Import the data
```{r}
data("engagement", package = "tna")
```

MMM clustering initialization
```{r, warning = F, cache = TRUE}
set.seed(265)

tna_model <- tna(engagement)
Nvar <- length(tna_model$labels)
Nclusters <- 3
trans_probs <- simulate_transition_probs(Nvar, Nclusters)
init_probs <-list(c(0.70, 0.20, 0.10),
                  c(0.15, 0.70, 0.15),
                  c(0.10, 0.20, 0.70))
```

Building and fitting the model (this might take a while...)
```{r, warning = F, cache = TRUE}
set.seed(265)
modelTrans <- build_mmm(engagement, transition_probs = trans_probs,
 initial_probs = init_probs)

controlEM = list(restart = list(times = 100, n_optimum = 101))

fitModelTrans <- fit_model(
 modelTrans,
 global_step = TRUE,
 control_global = list(algorithm = "NLOPT_GD_STOGO_RAND"),
 local_step = TRUE,
 threads = 60,
 control_em = controlEM)
```


Creating a new model with the cluster information
```{r}
tna_model_clus <- group_tna(fitModelTrans$model)
```

Summary
```{r}
summary(tna_model_clus) |> gt() |> fmt_number(decimals = 2)
```



Initial probabilities
```{r}
bind_rows(lapply(tna_model_clus, \(x) x$inits), .id = "Cluster") |>
  gt() |> fmt_percent()
```

Transition probabilities
```{r}
tna_model_clus[[1]]$weights |> data.frame() |>
  rownames_to_column("From\\To") |> gt() |>
  tab_header(title = names(tna_model_clus)[1]) |>
  fmt_percent()
tna_model_clus[[2]]$weights  |> data.frame() |>
  rownames_to_column("From\\To") |> gt() |>
  tab_header(title = names(tna_model_clus)[2]) |>
  fmt_percent()
tna_model_clus[[3]]$weights |> data.frame() |>
  rownames_to_column("From\\To") |> gt() |>
  tab_header(title = names(tna_model_clus)[3]) |>
  fmt_percent()
```
Plotting the cluster transitions
```{r, fig.width=6, fig.height=2}
layout(t(1:3))
plot(tna_model_clus)
```
Pruning rare transitions
```{r}
pruned_clus <- prune(tna_model_clus, threshold = 0.1)
```

Plotting the cluster transitions after pruning
```{r, fig.width=6, fig.height=2, message = F}
layout(t(1:3))
plot(pruned_clus)
```
 
Cluster centralities
```{r, fig.width=9, fig.height=4}
centrality_measures <- c("BetweennessRSP", "Closeness", "InStrength", "OutStrength")
centralities_per_cluster <- centralities(tna_model_clus,
                                         measures = centrality_measures)
plot(centralities_per_cluster,
     colors = c("purple","orange","pink"))
```
